# Dify 家庭服务器 Docker 部署完整使用指南

## 📖 目录

1. [项目概述](#项目概述)
2. [脚本命令详解](#脚本命令详解)
3. [配置文件说明](#配置文件说明)
4. [数据库操作指南](#数据库操作指南)
5. [数据持久化管理](#数据持久化管理)
6. [故障排除](#故障排除)
7. [高级用法](#高级用法)
8. [维护和监控](#维护和监控)

---

## 🎯 项目概述

### **项目结构**
```
dify-server/
├── docker-compose.yml          # Docker服务编排文件
├── docker-setup-updated.sh     # 主管理脚本
├── dify.env                    # 环境变量配置
├── redis.conf                 # Redis配置文件
├── init-scripts/              # 数据库初始化脚本
│   └── 01-init.sql
├── backups/                   # 备份文件目录
├── logs/                      # 日志文件目录
└── connection-info.md         # 连接信息文档
```

### **服务组件**
- **PostgreSQL 15** - 主数据库 (端口: 5432)
- **Redis 7** - 缓存和会话存储 (端口: 6379)
- **Weaviate 1.19** - 向量数据库 (端口: 8080)

### **数据持久化**
- 使用Docker命名卷确保数据安全
- 支持完整备份和恢复
- 容器重启数据不丢失

---

## 🔧 脚本命令详解

### **基础命令**

#### **1. setup - 初始化部署**
```bash
./docker-setup-updated.sh setup
```

**功能：**
- 检查Docker环境依赖
- 自动检测服务器IP地址
- 验证配置文件完整性
- 同步密码配置
- 拉取Docker镜像
- 创建必要目录

**使用场景：**
- 首次部署时使用
- 重新配置环境时使用

**输出示例：**
```
[INFO] 初始化 Dify 家庭服务器部署...
[SUCCESS] 依赖检查通过
[SUCCESS] 配置文件检查通过
[SUCCESS] 配置验证通过
[SUCCESS] 环境配置已更新: 192.168.1.100
[SUCCESS] Redis密码已同步
[INFO] 拉取Docker镜像...
[SUCCESS] 初始化完成！
```

#### **2. start - 启动服务**
```bash
./docker-setup-updated.sh start
```

**功能：**
- 启动前自动同步密码配置
- 启动所有Docker容器
- 等待服务完全启动
- 显示服务状态报告

**启动顺序：**
1. PostgreSQL (约10秒)
2. Redis (约5秒)
3. Weaviate (约30秒)

#### **3. stop - 停止服务**
```bash
./docker-setup-updated.sh stop
```

**功能：**
- 优雅停止所有容器
- 保留数据卷和网络

#### **4. restart - 重启服务**
```bash
./docker-setup-updated.sh restart
```

**功能：**
- 先停止所有服务
- 等待5秒
- 重新启动所有服务

### **监控命令**

#### **5. status - 查看服务状态**
```bash
./docker-setup-updated.sh status
```

**显示内容：**
- Docker容器运行状态
- 服务健康检查结果
- 端口监听状态

**输出示例：**
```
=== Dify 服务器状态 ===

Docker 容器状态:
NAME            IMAGE                           STATUS
dify-postgres   postgres:15-alpine             Up 5 minutes (healthy)
dify-redis      redis:7-alpine                 Up 5 minutes (healthy)  
dify-weaviate   semitechnologies/weaviate:1.19.0   Up 5 minutes (healthy)

服务健康状态:
✅ PostgreSQL: 健康
✅ Redis: 健康
✅ Weaviate: 健康
```
<code_block_to_apply_changes_from>
```
[INFO] 同步配置文件密码...
[INFO] 从环境文件读取的Redis密码: MyNewPassword123
[INFO] 当前redis.conf中的密码: OldPassword123
[WARNING] Redis密码不匹配，正在同步...
[SUCCESS] Redis配置已同步

=== 密码配置摘要 ===
PostgreSQL密码: MyPostgresPassword123
Redis密码: MyNewPassword123
Weaviate API Key: MyWeaviateKey123
```

#### **9. info - 显示连接信息**
```bash
./docker-setup-updated.sh info
```

**显示内容：**
- 服务器IP和端口信息
- 数据库连接字符串
- API密钥信息
- 防火墙配置命令
- 密码同步状态

### **数据管理命令**

#### **10. backup - 数据备份**
```bash
./docker-setup-updated.sh backup
```

**备份内容：**
- PostgreSQL数据库导出 (SQL格式)
- Redis数据导出 (RDB格式)
- Weaviate数据卷备份 (tar.gz格式)
- 配置文件备份

**备份位置：**
```
backups/20241219_143022/
├── postgres_backup.sql      # PostgreSQL数据
├── redis_backup.rdb         # Redis数据
├── weaviate_backup.tar.gz   # Weaviate数据
├── config_backup.tar.gz     # 配置文件
└── backup_info.txt          # 备份信息
```

**自动清理：**
- 保留最近7天的备份
- 自动删除过期备份

#### **11. clean - 清理数据**
```bash
./docker-setup-updated.sh clean
```

**⚠️ 危险操作 - 需要确认**
- 停止所有服务
- 删除所有数据卷
- 清空数据库内容
- 需要输入 'YES' 确认

---

## ⚙️ 配置文件说明

### **dify.env - 环境变量配置**

```env
# =================================
# 端口配置
# =================================
POSTGRES_PORT=5432
REDIS_PORT=6379
WEAVIATE_PORT=8080

# =================================
# PostgreSQL 数据库配置
# =================================
POSTGRES_DB=dify
POSTGRES_USER=dify
POSTGRES_PASSWORD=MySecurePassword123

# =================================
# Redis 配置
# =================================
REDIS_PASSWORD=MyRedisPassword123

# =================================
# Weaviate 向量数据库配置
# =================================
WEAVIATE_API_KEY=MyWeaviateKey123

# =================================
# 服务器配置
# =================================
SERVER_IP=192.168.1.100
```

**配置说明：**
- **端口配置**：可自定义各服务端口
- **密码配置**：建议使用强密码
- **服务器IP**：自动检测，可手动修改

### **redis.conf - Redis配置**

```conf
# 网络配置
bind 0.0.0.0
port 6379
protected-mode no

# 认证
requirepass MyRedisPassword123

# 内存管理
maxmemory 1gb
maxmemory-policy allkeys-lru

# 持久化配置
save 900 1
save 300 10
save 60 10000
appendonly yes
appendfsync everysec
```

**重要配置：**
- **requirepass**：必须与 `dify.env` 中的 `REDIS_PASSWORD` 一致
- **maxmemory**：根据服务器内存调整
- **持久化**：确保数据安全

### **docker-compose.yml - 服务编排**

**数据卷配置：**
```yaml
volumes:
  postgres_data:    # PostgreSQL数据持久化
    driver: local
  redis_data:       # Redis数据持久化
    driver: local
  weaviate_data:    # Weaviate数据持久化
    driver: local
```

**网络配置：**
```yaml
networks:
  dify-network:
    driver: bridge
```

---

## 🗄️ 数据库操作指南

### **PostgreSQL 数据库操作**

#### **连接数据库**
```bash
# 方式1：使用容器内psql
docker exec -it dify-postgres psql -U dify -d dify

# 方式2：从外部连接
psql "postgresql://dify:password@192.168.1.100:5432/dify"
```

#### **常用SQL操作**
```sql
-- 查看数据库版本
SELECT version();

-- 查看所有表
\dt

-- 查看表结构
\d table_name

-- 创建测试表
CREATE TABLE test_users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入测试数据
INSERT INTO test_users (username, email) VALUES 
('user1', 'user1@example.com'),
('user2', 'user2@example.com');

-- 查询数据
SELECT * FROM test_users;

-- 删除测试表
DROP TABLE test_users;
```

#### **数据库管理**
```bash
# 创建数据库备份
docker exec -t dify-postgres pg_dump -U dify dify > backup.sql

# 恢复数据库
cat backup.sql | docker exec -i dify-postgres psql -U dify -d dify

# 查看数据库大小
docker exec -it dify-postgres psql -U dify -d dify -c "
SELECT 
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database;"

# 查看表大小
docker exec -it dify-postgres psql -U dify -d dify -c "
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables 
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;"
```

### **Redis 缓存操作**

#### **连接Redis**
```bash
# 连接Redis (需要密码)
docker exec -it dify-redis redis-cli -a MyRedisPassword123

# 测试连接
docker exec -it dify-redis redis-cli -a MyRedisPassword123 ping
```

#### **常用Redis命令**
```bash
# 基础操作
SET key "value"
GET key
DEL key
EXISTS key

# 列表操作
LPUSH mylist "item1"
LPUSH mylist "item2"
LRANGE mylist 0 -1
LLEN mylist

# 哈希操作
HSET user:1 name "John"
HSET user:1 email "john@example.com"
HGET user:1 name
HGETALL user:1

# 集合操作
SADD myset "member1"
SADD myset "member2"
SMEMBERS myset

# 有序集合操作
ZADD leaderboard 100 "player1"
ZADD leaderboard 200 "player2"
ZRANGE leaderboard 0 -1 WITHSCORES

# 过期时间
EXPIRE key 3600  # 设置1小时过期
TTL key          # 查看剩余时间
```

#### **Redis监控**
```bash
# 查看Redis信息
docker exec -it dify-redis redis-cli -a MyRedisPassword123 INFO

# 查看内存使用
docker exec -it dify-redis redis-cli -a MyRedisPassword123 INFO memory

# 查看连接数
docker exec -it dify-redis redis-cli -a MyRedisPassword123 INFO clients

# 实时监控命令
docker exec -it dify-redis redis-cli -a MyRedisPassword123 MONITOR

# 查看慢查询
docker exec -it dify-redis redis-cli -a MyRedisPassword123 SLOWLOG GET 10
```

### **Weaviate 向量数据库操作**

#### **API访问**
```bash
# 检查Weaviate状态
curl -H "Authorization: Bearer MyWeaviateKey123" \
     http://192.168.1.100:8080/v1/.well-known/ready

# 获取集群信息
curl -H "Authorization: Bearer MyWeaviateKey123" \
     http://192.168.1.100:8080/v1/meta

# 查看schema
curl -H "Authorization: Bearer MyWeaviateKey123" \
     http://192.168.1.100:8080/v1/schema
```

#### **Python客户端示例**
```python
import weaviate

# 连接Weaviate
client = weaviate.Client(
    url="http://192.168.1.100:8080",
    auth_client_secret=weaviate.AuthApiKey(api_key="MyWeaviateKey123")
)

# 检查连接
print(client.is_ready())

# 创建类（schema）
class_schema = {
    "class": "Document",
    "description": "A document with text content",
    "properties": [
        {
            "name": "content",
            "dataType": ["text"],
            "description": "The content of the document"
        },
        {
            "name": "title", 
            "dataType": ["string"],
            "description": "The title of the document"
        }
    ]
}

client.schema.create_class(class_schema)

# 添加数据
client.data_object.create(
    data_object={
        "content": "This is a sample document content",
        "title": "Sample Document"
    },
    class_name="Document"
)

# 搜索
result = client.query.get("Document", ["content", "title"]).do()
print(result)
```

---

## 💾 数据持久化管理

### **数据卷管理**

#### **查看数据卷**
```bash
# 查看所有数据卷
docker volume ls

# 查看Dify相关数据卷
docker volume ls | grep docker_db

# 查看数据卷详细信息
docker volume inspect docker_db_postgres_data
docker volume inspect docker_db_redis_data
```

---

## 🎯 实施检查清单

### 部署完成检查

- [ ] Docker环境安装成功
- [ ] 所有配置文件创建完成
- [ ] 服务初始化成功
- [ ] 三个服务都处于健康状态
- [ ] 防火墙配置正确
- [ ] 网络连接测试通过
- [ ] 备份功能正常
- [ ] 定时任务设置完成
- [ ] 开机自启配置完成
- [ ] 文档整理完成

### 功能验证检查

- [ ] PostgreSQL可以正常连接和查询
- [ ] Redis可以正常读写数据
- [ ] Weaviate API可以正常访问
- [ ] 从其他机器可以连接到服务
- [ ] 备份文件完整且可用
- [ ] 服务重启后自动恢复
- [ ] 日志记录正常

---

## 📞 后续维护

### 日常维护任务

1. **每周检查**
   ```bash
   ./docker-setup.sh health
   ./docker-setup.sh status
   ```

2. **每月任务**
   ```bash
   # 清理旧镜像
   docker image prune -f
   
   # 检查备份
   ls -la backups/
   
   # 更新镜像 (可选)
   docker compose --env-file dify.env pull
   ```

3. **定期更新**
   - 关注Docker镜像更新
   - 定期更换密码
   - 监控磁盘空间使用

### 扩展功能

如需要监控系统，可以考虑：
- 添加Prometheus + Grafana
- 集成日志收集系统
- 配置告警通知

---

## ✅ 实施完成

恭喜！您已经成功完成了Dify家庭服务器的Docker部署。现在您拥有了一个稳定、可靠的开发环境，可以支持Dify应用的开发和测试工作。

**下一步建议：**
1. 在其他开发机器上测试连接
2. 开始部署Dify应用
3. 根据实际使用情况调整配置
4. 建立监控和告警机制

docker volume ls

# 查看特定数据卷详情
docker volume inspect docker_db_postgres_data
docker volume inspect docker_db_redis_data  
docker volume inspect docker_db_weaviate_data

# 查看数据卷大小
docker system df -v


echo "0 2 * * * cd $(pwd) && ./docker-setup-updated.sh backup" | crontab -

# 立即备份
./docker-setup-updated.sh backup

# 备份文件保存在 backups/ 目录
ls -la backups/


# 停止服务
./docker-setup-updated.sh stop

# 清理现有数据（可选）
docker volume rm docker_db_postgres_data docker_db_redis_data docker_db_weaviate_data

# 从备份恢复（需要手动操作）
# 1. 启动服务创建新的空数据卷
./docker-setup-updated.sh start

# 2. 恢复PostgreSQL
cat backups/20241219_143022/postgres_backup.sql | docker exec -i dify-postgres psql -U dify -d dify

# 3. 恢复Redis
docker cp backups/20241219_143022/redis_backup.rdb dify-redis:/data/dump.rdb
./docker-setup-updated.sh restart redis

# 4. 恢复Weaviate
docker run --rm -v docker_db_weaviate_data:/data -v $(pwd)/backups/20241219_143022:/backup alpine tar xzf /backup/weaviate_backup.tar.gz -C /data