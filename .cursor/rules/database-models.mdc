# æ•°æ®åº“æ¨¡å‹è§„èŒƒ

## ğŸ“‚ æ¨¡å‹æ–‡ä»¶ç»„ç»‡

### æ¨¡å‹å®šä¹‰ ([`api/models/`](mdc:api/models/))
```python
# models/account.py - ç”¨æˆ·è´¦æˆ·ç›¸å…³æ¨¡å‹
from sqlalchemy import Column, String, DateTime, Boolean, Text
from sqlalchemy.dialects.postgresql import UUID
from extensions.ext_database import db
import uuid
from datetime import datetime

class Account(db.Model):
    """ç”¨æˆ·è´¦æˆ·æ¨¡å‹"""
    __tablename__ = 'accounts'
    
    # ä¸»é”®ä½¿ç”¨UUID
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # åŸºç¡€å­—æ®µ
    email = Column(String(255), nullable=False, unique=True, index=True)
    password_hash = Column(String(255), nullable=False)
    name = Column(String(255), nullable=False)
    avatar = Column(String(255))
    
    # çŠ¶æ€å­—æ®µ
    status = Column(String(16), nullable=False, default='active')  # active, inactive, banned
    is_email_verified = Column(Boolean, nullable=False, default=False)
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    last_login_at = Column(DateTime)
    
    # è½¯åˆ é™¤
    deleted_at = Column(DateTime)
    
    def __repr__(self):
        return f'<Account {self.email}>'
    
    @property
    def is_active(self):
        """è´¦æˆ·æ˜¯å¦æ¿€æ´»"""
        return self.status == 'active' and self.deleted_at is None
```

### å…³è”æ¨¡å‹ç¤ºä¾‹
```python
# models/app.py - åº”ç”¨æ¨¡å‹
from sqlalchemy import Column, String, Text, ForeignKey, Integer
from sqlalchemy.orm import relationship
from extensions.ext_database import db

class App(db.Model):
    """AIåº”ç”¨æ¨¡å‹"""
    __tablename__ = 'apps'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # åŸºç¡€ä¿¡æ¯
    name = Column(String(255), nullable=False)
    description = Column(Text)
    icon = Column(String(255))
    
    # å…³è”ç”¨æˆ·
    created_by = Column(UUID(as_uuid=True), ForeignKey('accounts.id'), nullable=False)
    
    # é…ç½®ä¿¡æ¯
    mode = Column(String(255), nullable=False)  # chat, agent, workflow
    model_config = Column(Text)  # JSONé…ç½®
    
    # çŠ¶æ€
    status = Column(String(16), nullable=False, default='normal')
    enable_site = Column(Boolean, default=True)
    
    # æ—¶é—´æˆ³
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow)
    updated_at = Column(DateTime, nullable=False, default=datetime.utcnow, onupdate=datetime.utcnow)
    
    # å…³è”å…³ç³»
    created_by_account = relationship('Account', backref='apps')
    
    def __repr__(self):
        return f'<App {self.name}>'
```

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡åŸåˆ™

### 1. å­—æ®µå‘½åè§„èŒƒ
```python
# âœ… å¥½çš„å‘½å
class User(db.Model):
    id = Column(UUID(as_uuid=True), primary_key=True)
    email = Column(String(255), nullable=False)
    created_at = Column(DateTime, nullable=False)
    is_active = Column(Boolean, default=True)
    
# âŒ é¿å…çš„å‘½å
class User(db.Model):
    userId = Column(String(36))  # é¿å…é©¼å³°å‘½å
    e_mail = Column(String(255))  # é¿å…ä¸‹åˆ’çº¿è¿‡å¤š
    createTime = Column(DateTime)  # ä½¿ç”¨created_at
```

### 2. ç´¢å¼•ç­–ç•¥
```python
class Message(db.Model):
    __tablename__ = 'messages'
    
    id = Column(UUID(as_uuid=True), primary_key=True)
    conversation_id = Column(UUID(as_uuid=True), ForeignKey('conversations.id'), index=True)
    content = Column(Text, nullable=False)
    created_at = Column(DateTime, nullable=False, default=datetime.utcnow, index=True)
    
    # å¤åˆç´¢å¼•
    __table_args__ = (
        db.Index('idx_messages_conversation_created', 'conversation_id', 'created_at'),
        db.Index('idx_messages_user_created', 'from_account_id', 'created_at'),
    )
```

### 3. å¤–é”®çº¦æŸ
```python
class Conversation(db.Model):
    __tablename__ = 'conversations'
    
    id = Column(UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    app_id = Column(UUID(as_uuid=True), ForeignKey('apps.id', ondelete='CASCADE'), nullable=False)
    from_account_id = Column(UUID(as_uuid=True), ForeignKey('accounts.id'), nullable=False)
    
    # å®šä¹‰å…³è”å…³ç³»
    app = relationship('App', backref='conversations')
    from_account = relationship('Account', backref='conversations')
```

## ğŸ”„ æ•°æ®è¿ç§»è§„èŒƒ

### è¿ç§»æ–‡ä»¶ç»“æ„ ([`api/migrations/versions/`](mdc:api/migrations/versions/))
```python
"""æ·»åŠ ç”¨æˆ·è¡¨
Revision ID: 001_add_users_table
Revises: 
Create Date: 2024-01-01 00:00:00.000000
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = '001_add_users_table'
down_revision = None
branch_labels = None
depends_on = None

def upgrade():
    """å‡çº§æ•°æ®åº“ç»“æ„"""
    # åˆ›å»ºç”¨æˆ·è¡¨
    op.create_table(
        'accounts',
        sa.Column('id', postgresql.UUID(as_uuid=True), primary_key=True),
        sa.Column('email', sa.String(255), nullable=False),
        sa.Column('password_hash', sa.String(255), nullable=False),
        sa.Column('name', sa.String(255), nullable=False),
        sa.Column('avatar', sa.String(255)),
        sa.Column('status', sa.String(16), nullable=False, default='active'),
        sa.Column('is_email_verified', sa.Boolean(), nullable=False, default=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('updated_at', sa.DateTime(), nullable=False),
        sa.Column('last_login_at', sa.DateTime()),
        sa.Column('deleted_at', sa.DateTime()),
    )
    
    # åˆ›å»ºç´¢å¼•
    op.create_index('idx_accounts_email', 'accounts', ['email'], unique=True)
    op.create_index('idx_accounts_status', 'accounts', ['status'])
    op.create_index('idx_accounts_created_at', 'accounts', ['created_at'])

def downgrade():
    """å›æ»šæ•°æ®åº“ç»“æ„"""
    op.drop_index('idx_accounts_created_at', table_name='accounts')
    op.drop_index('idx_accounts_status', table_name='accounts')
    op.drop_index('idx_accounts_email', table_name='accounts')
    op.drop_table('accounts')
```

### æ•°æ®è¿ç§»ç¤ºä¾‹
```python
"""è¿ç§»ç”¨æˆ·æ•°æ®æ ¼å¼
Revision ID: 002_migrate_user_data
Revises: 001_add_users_table
Create Date: 2024-01-02 00:00:00.000000
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.sql import table, column

def upgrade():
    """
    å¤æ‚çš„æ•°æ®è¿ç§»é€»è¾‘
    å°†æ—§çš„ç”¨æˆ·æ•°æ®æ ¼å¼è¿ç§»åˆ°æ–°æ ¼å¼
    """
    # å®šä¹‰ä¸´æ—¶è¡¨ç»“æ„ç”¨äºæ•°æ®æ“ä½œ
    users_table = table(
        'accounts',
        column('id', sa.String),
        column('email', sa.String),
        column('old_field', sa.String),
        column('new_field', sa.String),
    )
    
    # æ‰¹é‡æ›´æ–°æ•°æ®
    connection = op.get_bind()
    
    # æŸ¥è¯¢éœ€è¦è¿ç§»çš„æ•°æ®
    result = connection.execute(
        sa.text("SELECT id, old_field FROM accounts WHERE new_field IS NULL")
    )
    
    # æ‰¹é‡å¤„ç†æ•°æ®
    for row in result:
        # è½¬æ¢æ•°æ®æ ¼å¼çš„é€»è¾‘
        new_value = transform_data(row.old_field)
        
        # æ›´æ–°æ•°æ®
        connection.execute(
            users_table.update()
            .where(users_table.c.id == row.id)
            .values(new_field=new_value)
        )

def transform_data(old_value):
    """
    æ•°æ®è½¬æ¢é€»è¾‘
    è¿™é‡Œå®ç°å…·ä½“çš„æ•°æ®æ ¼å¼è½¬æ¢
    """
    # ç®€å•çš„è½¬æ¢ç¤ºä¾‹
    if old_value:
        return old_value.strip().lower()
    return None

def downgrade():
    """å›æ»šæ•°æ®è¿ç§»"""
    # å®ç°å›æ»šé€»è¾‘
    pass
```

## ğŸ” æŸ¥è¯¢ä¼˜åŒ–

### 1. N+1æŸ¥è¯¢é—®é¢˜è§£å†³
```python
# âŒ ä¼šäº§ç”ŸN+1æŸ¥è¯¢
def get_apps_with_creators():
    apps = App.query.all()
    for app in apps:
        print(f"{app.name} by {app.created_by_account.name}")  # æ¯æ¬¡éƒ½æŸ¥è¯¢æ•°æ®åº“

# âœ… ä½¿ç”¨é¢„åŠ è½½è§£å†³
def get_apps_with_creators():
    apps = App.query.options(
        db.joinedload(App.created_by_account)
    ).all()
    for app in apps:
        print(f"{app.name} by {app.created_by_account.name}")  # ä¸ä¼šé¢å¤–æŸ¥è¯¢
```

### 2. åˆ†é¡µæŸ¥è¯¢
```python
def get_paginated_apps(page=1, per_page=20):
    """
    è·å–åˆ†é¡µçš„åº”ç”¨åˆ—è¡¨
    """
    pagination = App.query.filter(
        App.deleted_at.is_(None)
    ).order_by(
        App.created_at.desc()
    ).paginate(
        page=page,
        per_page=per_page,
        error_out=False
    )
    
    return {
        'items': pagination.items,
        'total': pagination.total,
        'page': pagination.page,
        'pages': pagination.pages,
        'has_prev': pagination.has_prev,
        'has_next': pagination.has_next,
    }
```

### 3. å¤æ‚æŸ¥è¯¢ç¤ºä¾‹
```python
def search_apps(keyword=None, status=None, created_by=None):
    """
    å¤æ‚çš„åº”ç”¨æœç´¢æŸ¥è¯¢
    æ”¯æŒå¤šä¸ªæ¡ä»¶çš„ç»„åˆæŸ¥è¯¢
    """
    query = App.query
    
    # åŸºç¡€è¿‡æ»¤æ¡ä»¶
    query = query.filter(App.deleted_at.is_(None))
    
    # å…³é”®è¯æœç´¢ï¼ˆæœç´¢åç§°å’Œæè¿°ï¼‰
    if keyword:
        search_pattern = f"%{keyword}%"
        query = query.filter(
            db.or_(
                App.name.ilike(search_pattern),
                App.description.ilike(search_pattern)
            )
        )
    
    # çŠ¶æ€è¿‡æ»¤
    if status:
        query = query.filter(App.status == status)
    
    # åˆ›å»ºè€…è¿‡æ»¤
    if created_by:
        query = query.filter(App.created_by == created_by)
    
    # æ’åº
    query = query.order_by(App.created_at.desc())
    
    return query
```

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨

### 1. è½¯åˆ é™¤å®ç°
```python
class BaseModel(db.Model):
    """åŸºç¡€æ¨¡å‹ï¼ŒåŒ…å«è½¯åˆ é™¤åŠŸèƒ½"""
    __abstract__ = True
    
    deleted_at = Column(DateTime)
    
    @classmethod
    def query_active(cls):
        """åªæŸ¥è¯¢æœªåˆ é™¤çš„è®°å½•"""
        return cls.query.filter(cls.deleted_at.is_(None))
    
    def soft_delete(self):
        """è½¯åˆ é™¤è®°å½•"""
        self.deleted_at = datetime.utcnow()
        db.session.commit()
    
    def restore(self):
        """æ¢å¤å·²åˆ é™¤çš„è®°å½•"""
        self.deleted_at = None
        db.session.commit()
```

### 2. æ•æ„Ÿæ•°æ®å¤„ç†
```python
class Account(db.Model):
    password_hash = Column(String(255), nullable=False)
    
    def set_password(self, password):
        """è®¾ç½®å¯†ç ï¼ˆè‡ªåŠ¨åŠ å¯†ï¼‰"""
        from werkzeug.security import generate_password_hash
        self.password_hash = generate_password_hash(password)
    
    def check_password(self, password):
        """éªŒè¯å¯†ç """
        from werkzeug.security import check_password_hash
        return check_password_hash(self.password_hash, password)
    
    def to_dict(self, include_sensitive=False):
        """è½¬æ¢ä¸ºå­—å…¸ï¼Œé»˜è®¤ä¸åŒ…å«æ•æ„Ÿä¿¡æ¯"""
        data = {
            'id': str(self.id),
            'email': self.email,
            'name': self.name,
            'avatar': self.avatar,
            'created_at': self.created_at.isoformat(),
        }
        
        if include_sensitive:
            # åªåœ¨ç‰¹æ®Šæƒ…å†µä¸‹åŒ…å«æ•æ„Ÿä¿¡æ¯
            data['last_login_at'] = self.last_login_at.isoformat() if self.last_login_at else None
        
        return data
```

## ğŸ“Š æ€§èƒ½ç›‘æ§

### 1. æŸ¥è¯¢æ€§èƒ½ç›‘æ§
```python
# åœ¨å¤æ‚æŸ¥è¯¢ä¸­æ·»åŠ æ€§èƒ½ç›‘æ§
import time
import logging

def expensive_query():
    """
    å¤æ‚çš„æŸ¥è¯¢æ“ä½œï¼Œéœ€è¦ç›‘æ§æ€§èƒ½
    """
    start_time = time.time()
    
    try:
        # æ‰§è¡Œå¤æ‚æŸ¥è¯¢
        result = db.session.execute(
            text("""
                SELECT a.*, COUNT(c.id) as conversation_count
                FROM apps a
                LEFT JOIN conversations c ON a.id = c.app_id
                WHERE a.deleted_at IS NULL
                GROUP BY a.id
                ORDER BY conversation_count DESC
                LIMIT 100
            """)
        ).fetchall()
        
        # è®°å½•æŸ¥è¯¢æ—¶é—´
        duration = time.time() - start_time
        if duration > 1.0:  # è¶…è¿‡1ç§’çš„æŸ¥è¯¢éœ€è¦å…³æ³¨
            logging.warning(f"Slow query detected: {duration:.2f}s")
        
        return result
        
    except Exception as e:
        logging.error(f"Query failed: {str(e)}")
        raise
```
description: æ•°æ®åº“è®¾è®¡è§„åˆ™
globs:
alwaysApply: false
---
