# Dify å®¶åº­æœåŠ¡å™¨ Docker éƒ¨ç½²æ–¹æ¡ˆ

è¿™æ˜¯ä¸€ä¸ªåŸºäºDockerçš„Difyå®¶åº­æœåŠ¡å™¨éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…å«PostgreSQLã€Rediså’ŒWeaviateä¸‰ä¸ªæ ¸å¿ƒæœåŠ¡ã€‚

## ğŸ“¦ æ–¹æ¡ˆç‰¹ç‚¹

- âœ… **çº¯Dockeræ–¹æ¡ˆ**: æ— éœ€ç³»ç»Ÿçº§é…ç½®ï¼Œåªéœ€Dockerç¯å¢ƒ
- âœ… **ä¸€é”®éƒ¨ç½²**: ç®€å•çš„è„šæœ¬æ“ä½œï¼Œè‡ªåŠ¨åŒ–ç¨‹åº¦é«˜
- âœ… **é…ç½®çµæ´»**: æ”¯æŒè‡ªå®šä¹‰ç«¯å£ã€å¯†ç ç­‰é…ç½®
- âœ… **æ•°æ®æŒä¹…åŒ–**: ä½¿ç”¨Dockerå·ä¿è¯æ•°æ®å®‰å…¨
- âœ… **å®Œæ•´å¤‡ä»½**: æ”¯æŒæ•°æ®åº“ã€é…ç½®æ–‡ä»¶å®Œæ•´å¤‡ä»½
- âœ… **å¥åº·æ£€æŸ¥**: å†…ç½®æœåŠ¡å¥åº·ç›‘æ§
- âœ… **å®‰å…¨åŠ å›º**: å¯†ç ä¿æŠ¤ã€ç½‘ç»œéš”ç¦»

## ğŸ—ï¸ æ¶æ„ç»„æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Dify å®¶åº­æœåŠ¡å™¨               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PostgreSQL (5432)  â”‚  Redis (6379)     â”‚
â”‚  â”œâ”€ æ•°æ®åº“å­˜å‚¨      â”‚  â”œâ”€ ç¼“å­˜æœåŠ¡      â”‚
â”‚  â”œâ”€ ç”¨æˆ·æ•°æ®        â”‚  â”œâ”€ ä¼šè¯ç®¡ç†      â”‚
â”‚  â””â”€ åº”ç”¨é…ç½®        â”‚  â””â”€ ä»»åŠ¡é˜Ÿåˆ—      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Weaviate (8080)    â”‚  Docker Network   â”‚
â”‚  â”œâ”€ å‘é‡æ•°æ®åº“      â”‚  â”œâ”€ æœåŠ¡é€šä¿¡      â”‚
â”‚  â”œâ”€ è¯­ä¹‰æœç´¢        â”‚  â”œâ”€ æ•°æ®éš”ç¦»      â”‚
â”‚  â””â”€ RAGæ”¯æŒ         â”‚  â””â”€ å®‰å…¨æ§åˆ¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‰ç½®è¦æ±‚

- Ubuntu 18.04+ æˆ–å…¶ä»–Linuxå‘è¡Œç‰ˆ
- Docker 20.10+ 
- Docker Compose V2
- 4GB+ å†…å­˜ (æ¨è8GB)
- 20GB+ å¯ç”¨ç£ç›˜ç©ºé—´

### 2. ä¸‹è½½éƒ¨ç½²æ–‡ä»¶

```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir dify-server && cd dify-server

# ä¸‹è½½æ‰€æœ‰å¿…è¦æ–‡ä»¶ (è¿™é‡Œå‡è®¾æ‚¨å·²ç»æœ‰äº†æ–‡ä»¶)
# docker-compose.yml
# docker-setup.sh
# dify.env
# redis.conf
# init-scripts/01-init.sql
```

### 3. åˆå§‹åŒ–éƒ¨ç½²

```bash
# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x docker-setup.sh

# åˆå§‹åŒ–éƒ¨ç½² (ä¼šè‡ªåŠ¨æ£€æµ‹IPã€ç”Ÿæˆå¯†ç )
./docker-setup.sh setup
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰æœåŠ¡
./docker-setup.sh start

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
./docker-setup.sh status
```

### 5. æŸ¥çœ‹è¿æ¥ä¿¡æ¯

```bash
# æ˜¾ç¤ºè¿æ¥ä¿¡æ¯å’Œå¯†ç 
./docker-setup.sh info
```

## ğŸ”§ ç®¡ç†å‘½ä»¤

```bash
# åŸºç¡€æ“ä½œ
./docker-setup.sh setup     # åˆå§‹åŒ–éƒ¨ç½²
./docker-setup.sh start     # å¯åŠ¨æœåŠ¡
./docker-setup.sh stop      # åœæ­¢æœåŠ¡
./docker-setup.sh restart   # é‡å¯æœåŠ¡
./docker-setup.sh status    # æŸ¥çœ‹çŠ¶æ€

# ç›‘æ§å’Œæ—¥å¿—
./docker-setup.sh health    # å¥åº·æ£€æŸ¥
./docker-setup.sh logs      # æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
./docker-setup.sh logs postgres  # æŸ¥çœ‹PostgreSQLæ—¥å¿—
./docker-setup.sh logs redis     # æŸ¥çœ‹Redisæ—¥å¿—
./docker-setup.sh logs weaviate  # æŸ¥çœ‹Weaviateæ—¥å¿—

# æ•°æ®ç®¡ç†
./docker-setup.sh backup    # å¤‡ä»½æ•°æ®
./docker-setup.sh clean     # æ¸…ç†æ•°æ® (å±é™©æ“ä½œ)
./docker-setup.sh info      # æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
```

## âš™ï¸ é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡é…ç½® (dify.env)

```env
# ç«¯å£é…ç½®
POSTGRES_PORT=5432
REDIS_PORT=6379
WEAVIATE_PORT=8080

# æ•°æ®åº“é…ç½®
POSTGRES_DB=dify
POSTGRES_USER=dify
POSTGRES_PASSWORD=your_password

# Redisé…ç½®
REDIS_PASSWORD=your_redis_password

# Weaviateé…ç½®
WEAVIATE_API_KEY=your_api_key

# æœåŠ¡å™¨IP (è‡ªåŠ¨æ£€æµ‹)
SERVER_IP=192.168.1.100
```

### è‡ªå®šä¹‰ç«¯å£

å¦‚éœ€ä¿®æ”¹ç«¯å£ï¼Œç¼–è¾‘ `dify.env` æ–‡ä»¶ï¼š

```bash
# ä¿®æ”¹ç«¯å£
POSTGRES_PORT=15432
REDIS_PORT=16379
WEAVIATE_PORT=18080

# é‡å¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆ
./docker-setup.sh restart
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. é˜²ç«å¢™è®¾ç½®

```bash
# å¼€æ”¾å¿…è¦ç«¯å£
sudo ufw allow 22/tcp      # SSH
sudo ufw allow 5432/tcp    # PostgreSQL
sudo ufw allow 6379/tcp    # Redis
sudo ufw allow 8080/tcp    # Weaviate
sudo ufw enable
```

### 2. å¯†ç å®‰å…¨

- è„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆå¼ºå¯†ç 
- å¯†ç å­˜å‚¨åœ¨ `dify.env` æ–‡ä»¶ä¸­
- å»ºè®®å®šæœŸæ›´æ¢å¯†ç 

### 3. ç½‘ç»œå®‰å…¨

- æœåŠ¡è¿è¡Œåœ¨ç‹¬ç«‹Dockerç½‘ç»œä¸­
- åªæš´éœ²å¿…è¦çš„ç«¯å£
- æ”¯æŒIPç»‘å®šé™åˆ¶è®¿é—®

## ğŸ’¾ æ•°æ®å¤‡ä»½

### è‡ªåŠ¨å¤‡ä»½

```bash
# æ‰§è¡Œå®Œæ•´å¤‡ä»½
./docker-setup.sh backup

# å¤‡ä»½å†…å®¹åŒ…æ‹¬:
# - PostgreSQLæ•°æ®åº“ (.sql)
# - Redisæ•°æ® (.rdb)
# - Weaviateå‘é‡æ•°æ® (.tar.gz)
# - é…ç½®æ–‡ä»¶ (.tar.gz)
```

### å¤‡ä»½ç­–ç•¥

- å¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨ `backups/` ç›®å½•
- è‡ªåŠ¨æ¸…ç†7å¤©å‰çš„å¤‡ä»½
- å»ºè®®è®¾ç½®å®šæ—¶å¤‡ä»½ä»»åŠ¡

```bash
# æ·»åŠ åˆ°crontab (æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½)
0 2 * * * cd /path/to/dify-server && ./docker-setup.sh backup
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡å¯åŠ¨å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ—¥å¿—
   ./docker-setup.sh logs
   
   # æ£€æŸ¥ç«¯å£å ç”¨
   sudo netstat -tulpn | grep :5432
   ```

2. **è¿æ¥è¢«æ‹’ç»**
   ```bash
   # æ£€æŸ¥é˜²ç«å¢™
   sudo ufw status
   
   # æ£€æŸ¥æœåŠ¡çŠ¶æ€
   ./docker-setup.sh health
   ```

3. **æ•°æ®ä¸¢å¤±**
   ```bash
   # æ£€æŸ¥æ•°æ®å·
   docker volume ls | grep dify
   
   # æ¢å¤å¤‡ä»½
   # (éœ€è¦æ‰‹åŠ¨æ“ä½œï¼Œå‚è€ƒå¤‡ä»½æ–‡ä»¶)
   ```

### å¥åº·æ£€æŸ¥

```bash
# æ‰§è¡Œå¥åº·æ£€æŸ¥
./docker-setup.sh health

# è¾“å‡ºç¤ºä¾‹:
# âœ… PostgreSQL: å¥åº·
# âœ… Redis: å¥åº·  
# âœ… Weaviate: å¥åº·
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### èµ„æºé…ç½®

- **PostgreSQL**: å·²ä¼˜åŒ–è¿æ¥æ•°ã€ç¼“å­˜ç­‰å‚æ•°
- **Redis**: é…ç½®å†…å­˜é™åˆ¶å’Œæ·˜æ±°ç­–ç•¥
- **Weaviate**: é€‚åˆä¸­å°è§„æ¨¡å‘é‡å­˜å‚¨

### ç›‘æ§å»ºè®®

è™½ç„¶æœ¬æ–¹æ¡ˆä¸åŒ…å«ç›‘æ§ç³»ç»Ÿï¼Œä½†æ‚¨å¯ä»¥ï¼š

1. ä½¿ç”¨ `docker stats` æŸ¥çœ‹èµ„æºä½¿ç”¨
2. å®šæœŸæ‰§è¡Œå¥åº·æ£€æŸ¥
3. ç›‘æ§å¤‡ä»½ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
4. å…³æ³¨æ—¥å¿—å¼‚å¸¸ä¿¡æ¯

## ğŸŒ å¼€å‘ç¯å¢ƒè¿æ¥

### è¿æ¥å­—ç¬¦ä¸²ç¤ºä¾‹

```bash
# PostgreSQL
postgresql://dify:your_password@192.168.1.100:5432/dify

# Redis  
redis://:your_redis_password@192.168.1.100:6379

# Weaviate
http://192.168.1.100:8080
API-Key: your_api_key
```

### åœ¨å…¶ä»–æœºå™¨ä¸Šä½¿ç”¨

1. ç¡®ä¿ç½‘ç»œå¯è¾¾
2. é…ç½®é˜²ç«å¢™è§„åˆ™
3. ä½¿ç”¨æ­£ç¡®çš„IPå’Œå¯†ç 
4. æµ‹è¯•è¿æ¥å¯ç”¨æ€§

## ğŸ“‹ æ–‡ä»¶ç»“æ„

```
dify-server/
â”œâ”€â”€ docker-compose.yml      # Docker Composeé…ç½®
â”œâ”€â”€ docker-setup.sh         # ç®¡ç†è„šæœ¬
â”œâ”€â”€ dify.env               # ç¯å¢ƒå˜é‡
â”œâ”€â”€ redis.conf             # Redisé…ç½®
â”œâ”€â”€ init-scripts/          # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚   â””â”€â”€ 01-init.sql
â”œâ”€â”€ backups/               # å¤‡ä»½ç›®å½•
â”œâ”€â”€ logs/                  # æ—¥å¿—ç›®å½• (å¯é€‰)
â””â”€â”€ README.md              # è¯´æ˜æ–‡æ¡£
```

## ğŸ†š ä¸ä¼ ç»Ÿéƒ¨ç½²å¯¹æ¯”

| ç‰¹æ€§ | Dockeræ–¹æ¡ˆ | ä¼ ç»Ÿè„šæœ¬æ–¹æ¡ˆ |
|------|------------|--------------|
| éƒ¨ç½²å¤æ‚åº¦ | â­â­ | â­â­â­â­ |
| ç³»ç»Ÿä¾èµ– | ä»…éœ€Docker | éœ€è¦å¤šä¸ªç³»ç»ŸåŒ… |
| é…ç½®ç®¡ç† | é›†ä¸­åŒ– | åˆ†æ•£åœ¨ç³»ç»Ÿä¸­ |
| æ•°æ®éš”ç¦» | å®Œå…¨éš”ç¦» | ç³»ç»Ÿçº§æ··åˆ |
| è¿ç§»ä¾¿åˆ©æ€§ | éå¸¸å®¹æ˜“ | è¾ƒå¤æ‚ |
| èµ„æºå ç”¨ | ç¨é«˜ | è¾ƒä½ |
| ç»´æŠ¤éš¾åº¦ | ç®€å• | ä¸­ç­‰ |

## ğŸ¯ é€‚ç”¨åœºæ™¯

âœ… **é€‚åˆçš„åœºæ™¯:**
- å®¶åº­/å°å›¢é˜Ÿå¼€å‘ç¯å¢ƒ
- å¿«é€ŸåŸå‹éªŒè¯
- å­¦ä¹ å’Œæµ‹è¯•ç”¨é€”
- éœ€è¦å¿«é€Ÿéƒ¨ç½²çš„åœºæ™¯
- å¤šç¯å¢ƒéƒ¨ç½²éœ€æ±‚

âŒ **ä¸é€‚åˆçš„åœºæ™¯:**
- å¤§è§„æ¨¡ç”Ÿäº§ç¯å¢ƒ
- éœ€è¦å¤æ‚ç›‘æ§çš„åœºæ™¯
- å¯¹æ€§èƒ½è¦æ±‚æé«˜çš„åº”ç”¨
- éœ€è¦ä¸ç°æœ‰ç³»ç»Ÿæ·±åº¦é›†æˆ

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Dockerå’ŒDocker Composeç‰ˆæœ¬
2. ç³»ç»Ÿèµ„æºæ˜¯å¦å……è¶³
3. ç½‘ç»œå’Œé˜²ç«å¢™é…ç½®
4. æ—¥å¿—é”™è¯¯ä¿¡æ¯

è¿™ä¸ªDockeræ–¹æ¡ˆæä¾›äº†ä¸€ä¸ªç®€æ´ã€å¯é çš„Difyå®¶åº­æœåŠ¡å™¨éƒ¨ç½²é€‰æ‹©ï¼
